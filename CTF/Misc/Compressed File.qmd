# Compressed File - 压缩包研究

在 Misc 领域中，压缩包分析是一个非常重要的知识点。它涵盖了文件数据结构的识别、CRC 校验算法等内容，是每位 Misc 手乃至 CTFer 都必须掌握的基础知识。

## zip 压缩包

ZIP 文件格式是一种广泛使用的数据压缩和文档存储格式，由菲尔 · 卡茨（`Phil Katz`）于 1989 年发明。ZIP 文件通常使用 `.zip` 作为后缀名，其 MIME 格式为 `application/zip`。

### zip 文件结构

一个 ZIP 文件由三部分组成：

1. **压缩源文件数据区**：存储压缩后的文件数据。
2. **压缩源文件目录区**：存储文件的元信息，如文件名、压缩方法、CRC 校验值等。
3. **压缩源文件目录结束标志**：标识 ZIP 文件的结束。

#### zip 文件源数据区

- **结构**：每个文件的压缩数据以一个本地文件头开始，后跟压缩数据。
- **本地文件头**：包含文件名、压缩方法、CRC 校验值、压缩前后大小等信息。
- **示例**：
  
  ```plaintext
  50 4B 03 04 14 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  ```

  其中 `50 4B 03 04` 是 ZIP 文件头的魔数。

#### zip 文件源数据目录区

- **结构**：存储文件的元信息，包括文件名、压缩方法、CRC 校验值、文件偏移量等。
- **目录条目**：每个文件的元信息以一个目录条目表示。
- **示例**：
  
  ```plaintext
  50 4B 01 02 14 00 14 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  ```

  其中 `50 4B 01 02` 是目录条目的魔数。

#### zip 文件源数据目录结束区

- **结构**：标识 ZIP 文件的结束，包含目录区的总条目数、目录区大小等信息。
- **结束标志**：`50 4B 05 06` 是 ZIP 文件结束标志的魔数。
- **示例**：
  
  ```plaintext
  50 4B 05 06 00 00 00 00 01 00 01 00 2E 00 00 00 00 00
  ```

### zip 文件常见考点

#### zip 伪加密

- **原理**：通过修改 ZIP 文件的加密标志位，使其看起来像是加密的，但实际上并未加密。
- **工具**：`010 Editor`、`ZipCenOp`。
- **修复方法**：将加密标志位修改为 `00 00`。

#### zip crc 爆破

- **原理**：通过已知文件的 CRC 校验值，暴力破解文件内容。
- **工具**：`pkcrack`、`bkcrack`。
- **适用场景**：已知部分文件内容或文件大小较小。

#### zip 嵌套操作

- **原理**：多个 ZIP 文件嵌套压缩，增加解压难度。
- **工具**：`binwalk`、`foremost`。
- **解决方法**：逐层解压，分析每层压缩包内容。

#### zip 明文攻击

- **原理**：通过已知的明文文件内容，破解 ZIP 文件的加密密钥。
- **工具**：`pkcrack`。
- **适用场景**：已知 ZIP 文件中某个未加密文件的内容。

## rar 压缩包

RAR 是一种高效的文件压缩格式，由 Eugene Roshal 开发，通常使用 `.rar` 作为后缀名。

### rar 文件结构

- **文件头**：包含 RAR 文件的版本、压缩方法等信息。
- **文件数据块**：存储压缩后的文件数据。
- **文件尾**：标识 RAR 文件的结束。

### rar 文件常见考点

#### rar 伪加密

- **原理**：通过修改 RAR 文件的加密标志位，使其看起来像是加密的，但实际上并未加密。
- **工具**：`010 Editor`。
- **修复方法**：将加密标志位修改为 `00 00`。

#### rar 嵌套操作

- **原理**：多个 RAR 文件嵌套压缩，增加解压难度。
- **工具**：`binwalk`、`foremost`。
- **解决方法**：逐层解压，分析每层压缩包内容。

## 7z 压缩包

7z 是一种高压缩率的文件格式，由 Igor Pavlov 开发，通常使用 `.7z` 作为后缀名。

### 7z 文件结构

- **文件头**：包含 7z 文件的版本、压缩方法等信息。
- **文件数据块**：存储压缩后的文件数据。
- **文件尾**：标识 7z 文件的结束。

### 7z 文件常见考点

- **高压缩率**：7z 文件通常使用 LZMA 或 LZMA2 算法，压缩率较高。
- **嵌套压缩**：多个 7z 文件嵌套压缩，增加解压难度。
- **工具**：`7-Zip`、`binwalk`。

---

## 实践与练习

1. **ZIP 伪加密**：使用 `010 Editor` 修改 ZIP 文件的加密标志位，尝试解压。
2. **ZIP CRC 爆破**：使用 `bkcrack` 工具，通过已知的 CRC 值暴力破解文件内容。
3. **RAR 嵌套解压**：解压一个嵌套的 RAR 文件，分析每层压缩包内容。
4. **7z 文件分析**：使用 `7-Zip` 解压一个 7z 文件，分析其压缩率和文件结构。
