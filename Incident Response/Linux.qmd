# Linux 上机排查

在 Linux 系统中进行上机排查是网络安全事件响应的重要环节，主要涉及进程行为、文件系统和网络行为的分析。通过排查，可以发现异常进程、恶意文件以及可疑的网络连接，从而判断系统是否被入侵或存在潜在威胁。

## 进程行为

进程行为排查是检测系统中是否存在异常进程的关键步骤，重点关注高 CPU 占用和网络占用的进程。

### 高占用计算

- **排查方法**：
  - 使用 `top` 或 `htop` 命令查看 CPU 占用率最高的进程。
  - 使用 `ps aux --sort=-%cpu` 按 CPU 占用率排序显示进程。
- **异常判断**：
  - 如果某个未知进程长期占用大量 CPU 资源，可能是恶意程序（如挖矿软件）。
- **示例**：

  ```bash
  top
  ps aux --sort=-%cpu | head -n 10
  ```

### 高占用网络

- **排查方法**：
  - 使用 `iftop` 或 `nethogs` 查看网络流量。
  - 使用 `netstat -antp` 或 `ss -antp` 查看网络连接。
- **异常判断**：
  - 如果某个进程存在大量未知的网络连接或高流量，可能是恶意程序（如后门或 C2 客户端）。
- **示例**：

  ```bash
  iftop
  netstat -antp | grep ESTABLISHED
  ```

## 文件排查

文件排查是检测系统中是否存在恶意文件的关键步骤，重点关注临时目录、用户目录、可执行目录和特殊权限文件。

### 临时目录

- **目录路径**：
  - `/tmp`
  - `/var/tmp`
- **排查方法**：
  - 使用 `ls -la /tmp` 查看临时目录中的文件。
  - 检查是否有可疑文件或脚本。
- **异常判断**：
  - 如果存在未知的可执行文件或脚本，可能是攻击者留下的后门。

### 用户目录

- **目录路径**：
  - `/home/*`
  - `/root`
- **排查方法**：
  - 使用 `ls -la /home/username` 查看用户目录中的文件。
  - 检查是否有隐藏文件或可疑文件。
- **异常判断**：
  - 如果存在 `.bashrc` 或 `.profile` 等配置文件的异常修改，可能是攻击者的持久化手段。

### 可执行目录

- **目录路径**：
  - `/usr/bin`
  - `/usr/sbin`
  - `/bin`
  - `/sbin`
- **排查方法**：
  - 使用 `ls -la /usr/bin` 查看可执行文件。
  - 检查是否有未知或可疑的可执行文件。
- **异常判断**：
  - 如果存在未知的可执行文件，可能是攻击者植入的恶意程序。

### 特殊权限文件

#### SUID 文件

- **概述**：SUID（Set User ID）文件是一种特殊权限文件，允许用户以文件拥有者的权限执行程序。
- **排查方法**：
  - 使用 `find / -perm -4000 -o -perm -2000` 查找所有 SUID 和 SGID 文件。
  - 检查是否有可疑的 SUID 文件。
- **异常判断**：
  - 如果存在未知的 SUID 文件，可能是攻击者提权的手段。
- **示例**：

  ```bash
  find / -perm -4000 -o -perm -2000
  ```

## 网络行为

网络行为排查是检测系统中是否存在异常网络连接的关键步骤，重点关注监听端口和现有网络连接。

### 检查监听端口

- **排查方法**：
  - 使用 `netstat -tuln` 或 `ss -tuln` 查看所有监听端口。
  - 使用 `lsof -i :端口号` 查看占用指定端口的进程。
- **异常判断**：
  - 如果存在未知的监听端口，可能是攻击者开启的后门。
- **示例**：

  ```bash
  netstat -tuln
  lsof -i :8080
  ```

### 检查现有网络连接

- **排查方法**：
  - 使用 `netstat -antp` 或 `ss -antp` 查看所有网络连接。
  - 使用 `lsof -i` 查看所有网络连接及其对应的进程。
- **异常判断**：
  - 如果存在未知的远程连接或大量连接，可能是恶意程序的 C2 通信。
- **示例**：

  ```bash
  netstat -antp | grep ESTABLISHED
  lsof -i
  ```
